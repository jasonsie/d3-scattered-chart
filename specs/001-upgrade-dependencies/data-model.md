# Data Model: Dependency Upgrade

**Feature**: 001-upgrade-dependencies  
**Date**: 2025-12-01  
**Status**: Complete

## Overview

This data model defines the entities, validation rules, and state transitions for the dependency upgrade feature. Unlike typical application features with database entities, this upgrade focuses on configuration entities (package.json, yarn.lock, tsconfig.json) and their validation rules.

---

## Entity 1: Package Manifest (package.json)

### Description
The npm package manifest that declares all project dependencies, version constraints, scripts, and runtime requirements.

### Fields

| Field | Type | Required | Validation Rules | Description |
|-------|------|----------|------------------|-------------|
| `name` | string | Yes | Non-empty, lowercase, no spaces | Package name identifier |
| `version` | string | Yes | Semantic version (x.y.z) | Current project version |
| `private` | boolean | Yes | Must be `true` | Prevents accidental npm publish |
| `engines.node` | string | Yes | Semver range starting with >=20.9.0 | Node.js runtime constraint |
| `scripts.dev` | string | Yes | Must contain `next dev` | Development server command |
| `scripts.build` | string | Yes | Must contain `next build` | Production build command |
| `scripts.start` | string | Yes | Must contain `next start` | Production server command |
| `scripts.lint` | string | Yes | Must contain `next lint` or `eslint` | Code linting command |
| `dependencies.*` | string | Conditional | Valid semver range | Production dependencies |
| `devDependencies.*` | string | Conditional | Valid semver range | Development dependencies |

### Target Dependency Versions (Validation Rules)

**Production Dependencies**:
- `next`: Must be `^16.0.0` (caret range allows patch/minor updates)
- `react`: Must be `^19.2.0`
- `react-dom`: Must be `^19.2.0`
- `@mui/material`: Must be `^7.3.5`
- `@mui/icons-material`: Must be `^7.3.5`
- `@emotion/react`: Must be `^11.14.0`
- `@emotion/styled`: Must be `^11.14.0`
- `d3`: Must be `^7.9.0` (no change from current)

**Development Dependencies**:
- `typescript`: Must be `^5.9.3`
- `@types/react`: Must be `^19`
- `@types/react-dom`: Must be `^19`
- `@types/d3`: Must be `^7.4.3`
- `@types/node`: Must be `^22`
- `eslint`: Must be `^9`
- `eslint-config-next`: Must be `^16.0.0`

### Peer Dependency Constraints

Must satisfy:
- `@mui/material@7.3.5` requires `react@^19.0.0` and `react-dom@^19.0.0`
- `@emotion/react@11.14.0` requires `react@^19.0.0`
- `@emotion/styled@11.14.0` requires `@emotion/react@^11.14.0` and `react@^19.0.0`
- `eslint-config-next@16.0.0` requires `next@16.0.0`

### State Transitions

```
[Pre-Upgrade State]
  ├─> engines.node: unspecified or <20.9.0
  ├─> next: <16.0.0
  ├─> react/react-dom: <19.0.0
  └─> @mui/*: <7.0.0

[Upgrade In Progress]
  ├─> package.json modified with new versions
  ├─> yarn.lock not yet updated
  └─> Validation: PENDING

[Post-Upgrade State]
  ├─> All target versions set in package.json
  ├─> yarn.lock regenerated with new resolution tree
  └─> Validation: PASSED (peer dependencies satisfied)

[Rollback State]
  ├─> Git revert to pre-upgrade commit
  ├─> package.json restored to previous versions
  └─> yarn install restores pre-upgrade yarn.lock
```

---

## Entity 2: Dependency Lock File (yarn.lock)

### Description
Yarn's lock file that records exact resolved versions of all dependencies (direct and transitive) to ensure reproducible installations.

### Fields

| Field | Type | Required | Validation Rules | Description |
|-------|------|----------|------------------|-------------|
| `__metadata` | object | Yes | Contains yarn version | Lock file format metadata |
| `[package@version]` | object | Yes (per dep) | Contains resolution, checksum, dependencies | Resolved package entry |
| `resolution` | string | Yes | Exact package@version or tarball URL | Resolved package location |
| `checksum` | string | Yes | Valid SHA-512 hash | Package integrity verification |
| `dependencies` | object | Conditional | Map of package: semver | Transitive dependencies |

### Validation Rules

- Must be generated by `yarn install` (not manually edited)
- All packages referenced in package.json must have entries
- All peer dependencies must be satisfied (no missing peer warnings)
- No packages with known high/critical vulnerabilities (validated by `yarn audit`)
- Checksums must be valid (validates package integrity)

### State Transitions

```
[Pre-Upgrade State]
  ├─> Contains entries for React 18.x ecosystem
  ├─> Contains entries for Next.js 15.x
  └─> Contains entries for MUI 6.x

[yarn install executed]
  ├─> Lock file regenerated with new dependency tree
  ├─> All React 19 peer dependencies resolved
  └─> Transitive dependencies updated to compatible versions

[Post-Upgrade State]
  ├─> Contains entries for React 19.2.0 ecosystem
  ├─> Contains entries for Next.js 16.0.0
  ├─> Contains entries for MUI 7.3.5
  └─> Validation: yarn install succeeds without errors
```

---

## Entity 3: TypeScript Configuration (tsconfig.json)

### Description
TypeScript compiler configuration that defines type-checking rules, module resolution, and compilation targets.

### Fields

| Field | Type | Required | Validation Rules | Description |
|-------|------|----------|------------------|-------------|
| `compilerOptions.strict` | boolean | Yes | Must be `true` | Enable all strict type checks |
| `compilerOptions.target` | string | Yes | ES2017 or higher | JavaScript compilation target |
| `compilerOptions.lib` | array | Yes | Must include "dom", "dom.iterable", "esnext" | Type libraries to include |
| `compilerOptions.jsx` | string | Yes | Must be "preserve" for Next.js | JSX compilation mode |
| `compilerOptions.moduleResolution` | string | Yes | Must be "bundler" for Next.js 16 | Module resolution strategy |
| `compilerOptions.paths` | object | Optional | Valid path mappings | Import alias configuration |
| `compilerOptions.plugins` | array | Yes | Must include Next.js plugin | TypeScript language service plugins |
| `include` | array | Yes | Must cover all .ts/.tsx files | Files to type-check |
| `exclude` | array | Yes | Must include "node_modules" | Files to ignore |

### New Recommended Options (Post-Upgrade)

- `compilerOptions.noUncheckedSideEffectImports`: `true` (TypeScript 5.9+ feature for React 19)

### Validation Rules

- Strict mode must be enabled (Constitutional requirement)
- Must include Next.js TypeScript plugin
- Path aliases must resolve to existing directories
- No compiler errors when running `tsc --noEmit`

### State Transitions

```
[Pre-Upgrade State]
  ├─> Using TypeScript 5.x (pre-5.9.3)
  ├─> Type definitions for React 18
  └─> No noUncheckedSideEffectImports option

[Configuration Updated]
  ├─> Type definitions updated to @types/react@19
  ├─> Optional: Add noUncheckedSideEffectImports: true
  └─> Validation: tsc --noEmit passes

[Post-Upgrade State]
  ├─> All React 19 types recognized
  ├─> Improved type narrowing from TS 5.9
  └─> Zero type errors in codebase
```

---

## Entity 4: ESLint Configuration (eslint.config.mjs)

### Description
ESLint flat config file that defines code quality and style rules for the project.

### Fields

| Field | Type | Required | Validation Rules | Description |
|-------|------|----------|------------------|-------------|
| (default export) | array | Yes | Array of config objects | ESLint flat config format |
| `[].extends` | array | Conditional | Must include "next/core-web-vitals" | Extended config presets |
| `[].rules` | object | Optional | Valid ESLint rule configurations | Custom rule overrides |

### Validation Rules

- Must use `eslint-config-next@16.0.0` (matches Next.js version)
- Must extend Next.js recommended config
- No errors when running `yarn lint`

### State Transitions

```
[Pre-Upgrade State]
  ├─> eslint-config-next: <16.0.0
  └─> May have React 18-specific lint rules

[Configuration Updated]
  ├─> eslint-config-next upgraded to ^16.0.0
  └─> Validation: yarn lint passes

[Post-Upgrade State]
  ├─> ESLint rules aligned with Next.js 16 best practices
  └─> No React 19 compatibility warnings
```

---

## Entity 5: Node.js Runtime Environment

### Description
The JavaScript runtime environment executing the Next.js application.

### Properties

| Property | Type | Required | Validation Rules | Description |
|----------|------|----------|------------------|-------------|
| `process.version` | string | Yes | Must match /^v20\.([9-9]|[1-9][0-9]+)/ | Node.js version string |
| Environment variables | object | Optional | Valid key-value pairs | Runtime configuration |

### Validation Rules

- Must be Node.js version 20.9.0 or higher
- Must be LTS (Long-Term Support) release
- Must support ES modules (native in Node.js 20+)
- Must support Next.js 16 minimum requirements

### State Transitions

```
[Pre-Upgrade State]
  ├─> Node.js version: any (not enforced)
  └─> package.json engines field: missing or permissive

[Enforcement Added]
  ├─> package.json engines.node set to ">=20.9.0"
  └─> Yarn warns on incompatible versions

[Post-Upgrade State]
  ├─> Developers running >=20.9.0 (enforced by yarn warning)
  └─> CI/CD enforces exact version via .nvmrc or Docker
```

---

## Validation Rules Summary

### Pre-Install Validation
- [ ] package.json has all required target versions
- [ ] package.json engines.node is ">=20.9.0"
- [ ] All required scripts are defined

### Post-Install Validation
- [ ] `yarn install` completes without errors
- [ ] `yarn audit` shows zero high/critical vulnerabilities
- [ ] No peer dependency warnings in yarn output
- [ ] yarn.lock exists and is valid

### Build Validation
- [ ] `tsc --noEmit` passes with zero errors
- [ ] `yarn lint` passes with zero errors
- [ ] `yarn build` completes successfully
- [ ] Build output contains no deprecation warnings

### Runtime Validation
- [ ] `yarn dev` starts development server without errors
- [ ] Application loads in browser without console errors
- [ ] All React components render correctly
- [ ] All D3 visualizations render correctly
- [ ] Performance metrics within targets (≤5s load time)

---

## Relationships Between Entities

```
┌──────────────────┐
│  package.json    │──generates──┐
│  (dependencies)  │             │
└──────────────────┘             ▼
                          ┌──────────────┐
                          │  yarn.lock   │
                          │  (resolved)  │
                          └──────────────┘
                                 │
                                 │ locks versions for
                                 ▼
┌──────────────────┐      ┌──────────────┐
│  tsconfig.json   │◄─────│  node_modules│
│  (compiler cfg)  │types │  (@types/*)  │
└──────────────────┘      └──────────────┘
        │                        │
        │ configures             │ provides
        ▼                        ▼
┌──────────────────┐      ┌──────────────┐
│  TypeScript      │      │  React 19    │
│  Compiler        │      │  Next.js 16  │
└──────────────────┘      │  MUI 7       │
        │                 │  D3.js 7     │
        │                 └──────────────┘
        │ validates              │
        ▼                        │ runs on
┌──────────────────┐             │
│  Source Code     │◄────────────┘
│  (*.ts, *.tsx)   │
└──────────────────┘
        │
        │ executes on
        ▼
┌──────────────────┐
│  Node.js 20.9.0+ │
│  Runtime         │
└──────────────────┘
```

---

## Edge Cases and Error Handling

### Peer Dependency Conflicts
- **Scenario**: Package X requires React 18, incompatible with React 19
- **Handling**: 
  1. Check for React 19-compatible version of Package X
  2. If unavailable: pin Package X to last compatible version
  3. Document pinning rationale in package.json comment
  4. Consider alternative packages if Package X is critical

### Transitive Dependency Vulnerabilities
- **Scenario**: Vulnerability exists in transitive dependency deep in tree
- **Handling**:
  1. Use `yarn audit` to identify vulnerable package
  2. Check if parent package has newer version that resolves it
  3. If not: use yarn `resolutions` field to force safe version
  4. Verify application still works after resolution override

### Breaking API Changes
- **Scenario**: React 19 deprecated API used in codebase
- **Handling**:
  1. TypeScript compilation will error on removed APIs
  2. Check React 19 migration guide for replacement API
  3. Update code to use new API pattern
  4. Test affected components thoroughly

### Build Failures
- **Scenario**: `yarn build` fails after upgrade
- **Handling**:
  1. Read error message for specific failure point
  2. Check if failure is Next.js config, TypeScript, or dependency issue
  3. Consult Next.js 16 migration guide for config changes
  4. If unresolvable within 2 hours: rollback and investigate offline

---

## Success Criteria Mapping

| Success Criterion | Validated By | Entity |
|-------------------|-------------|--------|
| SC-001: Node.js >=20.9.0 | package.json engines field | Package Manifest |
| SC-002: Next.js 16.0.0 | package.json dependencies.next | Package Manifest |
| SC-003: React 19.2.0 | package.json dependencies.react | Package Manifest |
| SC-004: MUI 7.3.5 | package.json dependencies.@mui/* | Package Manifest |
| SC-005: TypeScript 5.9.3 | package.json devDependencies.typescript | Package Manifest |
| SC-006: Zero vulnerabilities | yarn audit output | Dependency Lock File |
| SC-007: Production build succeeds | yarn build exit code | Build System |
| SC-008: Dev server no warnings | yarn dev console output | Development Server |
| SC-009: Features function | Manual testing | Application Runtime |
| SC-010: Build time within 15% | Build duration measurement | Build System |
| SC-011: No peer warnings | yarn install output | Dependency Lock File |
| SC-012: Staging tests pass | Manual acceptance testing | Application Runtime |
| SC-013: Load time ≤5s | Browser DevTools Performance | Application Runtime |

---

**Data Model Complete**: 2025-12-01  
**Next**: Generate contracts/ and quickstart.md
